<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Talk to me</title>
</head>
<style>
textarea {
}

.copy {
    
}
</style>
<body>
    <textarea cols="120" rows="6" id="info-out" onclick="this.select();" readonly></textarea>
    <textarea cols="120" rows="6" id="info-in"></textarea><br />
    <button id="info-in-button" type="button" onclick="maybeInfoIn();">Start</button>
    
    <script type="text/javascript" src="adapter-0.2.10.js"></script>
    <script type="text/javascript" src="sdputils.js"></script>
    <script type="text/javascript">
// First, checks if it isn't implemented yet.
if (!String.prototype.format) {
  String.prototype.format = function() {
    var args = arguments;
    return this.replace(/{(\d+)}/g, function(match, number) { 
      return typeof args[number] != 'undefined'
        ? args[number]
        : match
      ;
    });
  };
}
        
{
    iceServers: [{
        urls: 'stun:stun.l.google.com:19302'
    }]
}
var pc = new RTCPeerConnection();
var infoOutDone = false;
var infoInDone = false;
var offer = null;
var localCandidates = [];
var remoteCandidates = [];
var localMLineIndex;
var localMid;

var maybeInfoOut = function() {
    if (infoOutDone || offer === null || localCandidates.length === 0) {
        return;
    }
    var sections = SDPUtils.splitSections(offer.sdp);
    var session = sections.shift();
    var media = sections.shift();
    var iceParameters = SDPUtils.getIceParameters(media, session);
    var dtlsParameters = SDPUtils.getDtlsParameters(media, session);
    var localInfo = '{0}\n{1}\n{2}\n{3}'.format(iceParameters.usernameFragment,
        iceParameters.password, dtlsParameters.fingerprints[0].value, localCandidates.join('\n'));
    var localInfoBase64 = btoa(localInfo);
    console.log("Local Info (raw):\n", localInfo);
    document.getElementById('info-out').value = localInfoBase64;
};

var maybeInfoIn = function() {
    var remoteInfoBase64 = document.getElementById('info-in').value;
    if (infoInDone || remoteInfoBase64.length === 0) {
        return;
    }
    var remoteInfo = atob(remoteInfoBase64);
    console.log("Remote Info (raw):\n", remoteInfo);
    infoInDone = true;
    decodeAll();
    
    // Set answer
    var answer = generateAnswer(remoteInfo);
    console.log('Remote Description:\n', answer.sdp);
    pc.setRemoteDescription(answer)
    .then(function() {
        console.log('Set remote description');
        // Set remote candidates
        for (var i = 0; i < remoteCandidates.length; i++) {
            var candidate = new RTCIceCandidate({
                candidate: 'candidate:' + remoteCandidates[i],
                sdpMLineIndex: localMLineIndex,
                sdpMid: localMid
            });
            pc.addIceCandidate(candidate)
            .then(function() {
                console.log('Added remote candidate', candidate);
            });
        }
    });
};

var decodeAll = function() {
    document.getElementById('info-out').value = atob(document.getElementById('info-out').value);
    document.getElementById('info-in').value = atob(document.getElementById('info-in').value);
    document.getElementById('info-in').readOnly = true;
    document.getElementById('info-in-button').disabled = true;
};

var generateAnswer = function(remoteInfo) {
    var remoteInfoList = remoteInfo.split('\n');
    var ufrag = remoteInfoList.shift();
    var pwd = remoteInfoList.shift();
    var fingerprint = remoteInfoList.shift();
    remoteCandidates = remoteInfoList;
    
    // Create SDP
    var sdp = SDPUtils.writeSessionBoilerplate();
    sdp += 'a=msid-semantic: WMS\r\n';
    sdp += 'm=application 9 DTLS/SCTP 5000\r\n';
    sdp += 'c=IN IP4 0.0.0.0\r\n';
    sdp += SDPUtils.writeIceParameters({
        usernameFragment: ufrag,
        password: pwd
    });
    sdp += SDPUtils.writeDtlsParameters({
        fingerprints: [{
            algorithm: 'sha-256',
            value: fingerprint
        }]
    }, 'passive');
    sdp += 'a=mid:{0}\r\n'.format(localMid);
    sdp += 'a=sctpmap:5000 webrtc-datachannel 1024\r\n';
    
    // Create answer
    return new RTCSessionDescription({
        type: 'answer',
        sdp: sdp
    });
};

// Bind events
pc.onnegotiationneeded = function(event) {
    console.log("Event: onnegotiationneeded", event);
};
pc.onicecandidate = function(event) {
    console.log("Event: onicecandidate", event);
    if (event.candidate) {
        console.log("Candidate: ", event.candidate);
        localCandidates.push(event.candidate.candidate.slice(10, event.candidate.candidate.length));
        localMLineIndex = event.candidate.sdpMLineIndex;
        localMid = event.candidate.sdpMid;
    } else {
        console.log("End of candidates");
        maybeInfoOut();
    }
};
pc.onicecandidateerror = function(event) {
    console.log("Event: onicecandidateerror", event);
};
pc.onsignalingstatechange = function(event) {
    console.log("Event: onsignalingstatechange", pc.signalingState);
};
pc.oniceconnectionstatechange = function(event) {
    console.log("Event: oniceconnectionstatechange", pc.iceConnectionState);
};
pc.onicegatheringstatechange = function(event) {
    console.log("Event: onicegatheringstatechange", pc.iceGatheringState);
};
pc.onconnectionstatechange = function(event) {
    console.log("Event: onconnectionstatechange", pc.connectionState);
};

// Create data channel
var dc = pc.createDataChannel("therme", {
    ordered: true
});
dc.onopen = function() {
    console.log("Data Channel is open");
}
dc.openmessage = function(event) {
    console.log("Received data: ", data);
}

// Create offer
pc.createOffer()
.then(function(offer) {
    console.log('Local Description:\n', offer.sdp);
    return pc.setLocalDescription(offer);
})
.then(function() {
    offer = pc.localDescription;
    maybeInfoOut();
});
    </script>
</body>
</html>
